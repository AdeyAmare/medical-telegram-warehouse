# `scripts/` Folder

This folder contains **Python scripts** for scraping Telegram channels, loading raw data, and enriching images with YOLO detections into the PostgreSQL database.

---

## Scripts

### 1. `scraper.py`

**Purpose:**
Scrapes public Telegram channels related to Ethiopian medical and pharmaceutical businesses.

**Key Features:**

* Downloads messages and images from multiple channels.
* Stores messages as JSON files, images in a structured directory, and CSV backups.
* Logs the scraping process with timestamps and errors.
* Handles Telegram rate limits (`FloodWaitError`) and supports message/channel delays.

**Output Structure:**

```
data/
└── raw/
    ├── telegram_messages/YYYY-MM-DD/channel.json
    ├── images/{channel_name}/{message_id}.jpg
    └── csv/YYYY-MM-DD/telegram_data.csv
logs/
└── scrape_YYYY-MM-DD.log
```

**Usage:**

```bash
python scripts/scraper.py --path data --limit 300
```

**Required Environment Variables (.env):**

```text
Tg_API_ID=your_api_id
Tg_API_HASH=your_api_hash
```

---

### 2. `load_raw_data.py`

**Purpose:**
Loads the JSON messages produced by the scraper into a PostgreSQL database.

**Key Features:**

* Connects to a PostgreSQL database using credentials from `.env`.
* Creates the schema and table if they don’t exist.
* Reads JSON messages from `data/raw/telegram_messages/YYYY-MM-DD/`.
* Handles missing/invalid messages gracefully.
* Inserts messages into `raw.telegram_messages` table, avoiding duplicates.

**Required Environment Variables (.env):**

```text
DATABASE_NAME=your_db
DATABASE_USER=your_user
DATABASE_PASSWORD=your_password
DATABASE_HOST=your_host
DATABASE_PORT=your_port
```

**Usage:**

```bash
python scripts/load_raw_data.py
```

---

### 3. `load_yolo_postgres.py`

**Purpose:**
Loads YOLOv8 image detection results from CSV into PostgreSQL for downstream analytics.

**Key Features:**

* Reads `data/raw/yolo_detections.csv` generated by `src/yolo_detect.py`.
* Cleans data:

  * Ensures `message_id` is numeric.
  * Fills missing `confidence_score` with `0.0`.
  * Replaces empty `detected_objects` with `'none'`.
* Bulk inserts records into `raw.yolo_detections`.
* Creates the schema/table if they don’t exist.
* Tracks load timestamp in `loaded_at`.

**Usage:**

```bash
python scripts/load_yolo_postgres.py
```

**Required Environment Variables (.env):**

```text
DATABASE_NAME=your_db
DATABASE_USER=your_user
DATABASE_PASSWORD=your_password
DATABASE_HOST=your_host
DATABASE_PORT=your_port
```

---

## Comprehensive Usage

A typical workflow for the **Medical Telegram Warehouse pipeline** is:

1. **Scrape new Telegram messages and images:**

```bash
python scripts/scraper.py --path data --limit 500
```

2. **Load raw messages into PostgreSQL:**

```bash
python scripts/load_raw_data.py
```

3. **Run YOLO image detection pipeline (from `src/`):**

```bash
python -m yolo_detect
```

4. **Load YOLO detection results into PostgreSQL:**

```bash
python scripts/load_yolo_postgres.py
```

This ensures that:

* Raw Telegram messages are persisted in the database.
* Images are analyzed with YOLOv8.
* Detection results are loaded into `raw.yolo_detections` for enrichment and analytics.

---

**Summary:**

* `scraper.py` → Collects Telegram messages and images.
* `load_raw_data.py` → Loads raw messages into PostgreSQL.
* `yolo_detect.py` (in `src/`) → Performs image detection and categorization.
* `load_yolo_postgres.py` → Loads YOLO results into PostgreSQL for downstream use.
